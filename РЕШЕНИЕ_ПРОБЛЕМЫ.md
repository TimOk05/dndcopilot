# Решение проблем DnD Copilot

## Исправленные проблемы безопасности

### ✅ Устраненные уязвимости:

1. **API ключи в открытом виде**
   - Удален хардкод API ключа из `config.php`
   - Добавлена загрузка переменных окружения из `.env`
   - API ключи теперь хранятся безопасно

2. **Отсутствие проверки авторизации в API**
   - Добавлена проверка `isLoggedIn()` во все API файлы
   - API теперь доступны только авторизованным пользователям

3. **Небезопасная обработка файлов**
   - Улучшена валидация загружаемых PDF файлов
   - Добавлены проверки типа, размера и расширения файлов
   - Использованы константы из конфигурации

4. **Отсутствие CSRF защиты**
   - Добавлена проверка CSRF токенов в API запросы
   - Используется `sanitizeInput()` для очистки данных

5. **Защита конфиденциальных файлов**
   - Обновлен `.htaccess` для защиты `.env`, `users.json`, `login_attempts.json`
   - Добавлены заголовки безопасности

## Инструкции по настройке

### 1. Создание файла .env

Создайте файл `.env` в корне проекта:

```bash
# API ключи
DEEPSEEK_API_KEY=sk-1e898ddba737411e948af435d767e893

# Настройки приложения
DEBUG_MODE=false
ENVIRONMENT=production

# Настройки безопасности
SESSION_LIFETIME=28800
MAX_LOGIN_ATTEMPTS=5
LOCKOUT_TIME=900
PASSWORD_MIN_LENGTH=8
```

### 2. Проверка прав доступа

Убедитесь, что следующие файлы недоступны через веб:
- `.env`
- `users.json`
- `login_attempts.json`
- `config.php`

### 3. Тестирование безопасности

Запустите тест безопасности:
```
http://your-domain.com/test-security.php
```

## Возможные проблемы и решения

### Проблема: "API ключ не настроен"
**Решение:** Создайте файл `.env` с вашим API ключом

### Проблема: "Не авторизован" в API
**Решение:** Убедитесь, что пользователь вошел в систему

### Проблема: "Неверный CSRF токен"
**Решение:** Обновите страницу и попробуйте снова

### Проблема: Файлы недоступны
**Решение:** Проверьте права доступа к файлам (755 для директорий, 644 для файлов)

## Проверка работоспособности

1. **Вход в систему** - должен работать
2. **Регистрация** - должна работать
3. **AI чат** - должен работать с API ключом
4. **Генерация персонажей** - должна работать
5. **Система боя** - должна работать

## Логи и отладка

Логи записываются в `logs/app.log`. Для включения отладки установите в `.env`:
```
DEBUG_MODE=true
```

## Контакты

При возникновении проблем проверьте:
1. Файл `.env` создан и содержит API ключ
2. Права доступа к файлам настроены правильно
3. Логи в `logs/app.log` не содержат ошибок
