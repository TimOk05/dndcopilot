# Обновление системы регистрации

## Изменения в системе регистрации

### Основные изменения

1. **Удалены все старые пользователи** - файл `users.json` очищен
2. **Регистрация теперь возможна только через Google** - обычная регистрация отключена
3. **Google аккаунт + пароль для приложения** - пользователи могут входить как через Google, так и через установленный пароль

### Детали изменений

#### 1. Обновлена функция регистрации в `users.php`

**Старая версия:**
```php
function registerUser($username, $password, $email = null) {
    // Обычная регистрация
}
```

**Новая версия:**
```php
function registerUser($username, $password, $email = null, $googleId = null) {
    // Проверяем, что регистрация происходит только через Google
    if (!$googleId || !$email) {
        return ['success' => false, 'message' => 'Регистрация возможна только через Google аккаунт. Используйте кнопку "Зарегистрироваться через Google".'];
    }
    
    // ... остальная логика регистрации
}
```

**Изменения:**
- Добавлен обязательный параметр `$googleId`
- Проверка наличия Google ID и email
- Сохранение `google_id` и `auth_method` в профиле пользователя
- Проверка уникальности по email и google_id

#### 2. Обновлена функция аутентификации

**Изменения:**
- Поиск пользователя по email или username
- Проверка наличия пароля для Google аккаунтов
- Поддержка входа как через Google, так и через пароль

```php
// Ищем пользователя по email или username
foreach ($users as $u) {
    if (hash_equals($u['email'], $username) || hash_equals($u['username'], $username)) {
        $user = $u;
        break;
    }
}

// Проверяем, что у пользователя есть пароль (Google аккаунты с паролем)
if (!isset($user['password_hash']) || empty($user['password_hash'])) {
    return ['success' => false, 'message' => 'Для входа используйте Google аккаунт. У вас не установлен пароль для приложения.'];
}
```

#### 3. Обновлена страница входа (`login.php`)

**Изменения в форме регистрации:**
- Убрана обычная форма регистрации
- Добавлена информационная страница с пошаговой инструкцией
- Оставлена только кнопка "Зарегистрироваться через Google"

**Новая структура формы регистрации:**
```html
<div id="register-form" class="form-content">
    <div class="register-info">
        <h3>Регистрация через Google</h3>
        <p>Для регистрации в приложении необходимо использовать Google аккаунт...</p>
        
        <div class="register-steps">
            <div class="step">
                <div class="step-number">1</div>
                <div class="step-content">
                    <h4>Авторизация через Google</h4>
                    <p>Нажмите кнопку ниже для авторизации через ваш Google аккаунт</p>
                </div>
            </div>
            <!-- ... остальные шаги -->
        </div>
    </div>
    
    <a href="google-auth.php" class="google-btn register-google-btn">
        Зарегистрироваться через Google
    </a>
</div>
```

#### 4. Обновлен файл завершения регистрации (`google-complete-registration.php`)

**Изменения:**
- Использование новой функции `registerUser()` с Google ID
- Сохранение `auth_method` как `google_with_password`
- Установка сессии с правильным методом аутентификации

```php
// Создаем пользователя через Google с паролем
$result = registerUser($username, $password, $email, $googleUserData['id']);

if ($result['success']) {
    // ... поиск созданного пользователя
    $_SESSION['auth_method'] = 'google_with_password';
}
```

#### 5. Удалена обработка обычной регистрации

**Удалено из `users.php`:**
- Case `'register'` в switch statement
- Обработка обычной регистрации через POST

**Удалено из `login.php`:**
- JavaScript обработчик формы регистрации
- Валидация обычной формы регистрации

### Новый процесс регистрации

#### Шаг 1: Авторизация через Google
1. Пользователь нажимает "Зарегистрироваться через Google"
2. Перенаправление на Google OAuth
3. Получение данных пользователя от Google

#### Шаг 2: Завершение регистрации
1. Пользователь попадает на `google-complete-registration.php`
2. Заполняет дополнительные поля (имя пользователя, пароль для приложения)
3. Создается аккаунт с привязкой к Google

#### Шаг 3: Вход в систему
Пользователь может входить двумя способами:
1. **Через Google** - автоматический вход без пароля
2. **Через пароль** - используя email/username и пароль для приложения

### Структура данных пользователя

**Новая структура:**
```json
{
    "id": "unique_id",
    "username": "user_name",
    "email": "user@gmail.com",
    "google_id": "google_user_id",
    "password_hash": "hashed_password_for_app",
    "role": "user",
    "created_at": "2024-01-01 12:00:00",
    "is_active": true,
    "login_count": 0,
    "auth_method": "google_with_password"
}
```

**Поля:**
- `google_id` - ID пользователя в Google
- `auth_method` - метод аутентификации (`google_with_password`)
- `password_hash` - хеш пароля для входа в приложение

### Безопасность

1. **Обязательная привязка к Google** - все аккаунты связаны с Google
2. **Дополнительный пароль** - для входа в приложение без Google
3. **Проверка уникальности** - по email и google_id
4. **CSRF защита** - для всех форм
5. **Логирование** - всех действий регистрации и входа

### Обратная совместимость

- Старые пользователи удалены
- Все пользователи должны пройти новую регистрацию
- Система готова к работе с новой схемой

### Тестирование

Для проверки новой системы регистрации:

1. **Регистрация нового пользователя:**
   - Перейти на страницу входа
   - Выбрать "Регистрация через Google"
   - Пройти авторизацию через Google
   - Заполнить форму завершения регистрации

2. **Вход через Google:**
   - Нажать "Войти через Google"
   - Автоматический вход без пароля

3. **Вход через пароль:**
   - Использовать email или username
   - Ввести пароль для приложения

### Файлы, которые были изменены

1. `users.php` - обновлены функции регистрации и аутентификации
2. `login.php` - обновлена форма регистрации
3. `google-complete-registration.php` - обновлена логика завершения регистрации
4. `users.json` - очищен от старых пользователей

### Заключение

Система регистрации теперь полностью интегрирована с Google OAuth, обеспечивая безопасность и удобство для пользователей. Все старые пользователи удалены, и система готова к работе с новой схемой аутентификации.
