# Исправления генератора противников

## Проблемы, которые были исправлены:

### 1. **Несоответствие значений в форме и API**
**Было:** В форме использовались числовые значения CR (0, 0.125, 0.25, 0.5, 1, 2...)
**Стало:** Правильные строковые значения ('easy', 'medium', 'hard', 'deadly', 'random')

**Файл:** `index.php` (строки 623-680)
**Изменение:** Заменены все опции в select на корректные значения

### 2. **Отсутствие retry логики для API**
**Было:** Один запрос к D&D API, при ошибке - fallback
**Стало:** Retry логика с 3 попытками и задержкой между ними

**Файл:** `api/generate-enemies.php`
**Добавлено:**
- `getMonstersListWithRetry()` - метод с retry логикой
- `$max_retries = 3` - количество попыток
- `$retry_delay = 1000` - задержка между попытками (1 секунда)

### 3. **Отсутствие кэширования**
**Было:** Каждый запрос к D&D API
**Стало:** Кэширование списка монстров (1 час) и деталей монстров (24 часа)

**Добавлено:**
- `$cache_dir` - директория для кэша
- `getMonstersListWithCache()` - кэширование списка монстров
- `getMonsterDetailsWithCache()` - кэширование деталей монстров

### 4. **Улучшенная обработка ошибок**
**Было:** Простые сообщения об ошибках
**Стало:** Детальные сообщения с HTTP кодами и описанием проблем

**Улучшено:**
- `makeRequest()` - детальная обработка HTTP ошибок
- JavaScript - лучшая обработка сетевых ошибок
- Логирование всех этапов работы

### 5. **Убраны fallback данные**
**Было:** Использование локальных fallback данных
**Стало:** Только API D&D с retry и кэшированием

## Как теперь работает генерация:

1. **Выбор уровня угрозы:**
   - `easy` → CR 0-3 (Легкий)
   - `medium` → CR 1-7 (Средний) 
   - `hard` → CR 5-12 (Сложный)
   - `deadly` → CR 10-20 (Смертельный)
   - `random` → Случайный уровень

2. **Процесс генерации:**
   - Проверка кэша списка монстров
   - Если кэш устарел - запрос к D&D API с retry
   - Фильтрация по CR, типу и среде
   - Если монстры не найдены - расширение диапазона CR
   - Получение деталей монстров с кэшированием
   - Генерация AI описаний (если включено)

3. **Обработка ошибок:**
   - Retry при сетевых ошибках
   - Детальные сообщения об ошибках
   - Логирование всех проблем

## Файлы, которые были изменены:

1. **`index.php`** - исправлена форма генерации противников
2. **`api/generate-enemies.php`** - полностью переписан API
3. **`test-enemy-api.php`** - создан тестовый файл для диагностики
4. **`logs/cache/`** - создана директория для кэша

## Тестирование:

Запустите `test-enemy-api.php` в браузере для проверки:
- Подключения к D&D API
- Работы вашего API
- Логов и кэша

## Возможные проблемы и решения:

### 1. **API все еще не работает**
- Проверьте логи в `logs/app.log`
- Убедитесь, что D&D API доступен
- Проверьте настройки CURL в PHP

### 2. **Медленная работа**
- Проверьте кэш в `logs/cache/`
- Увеличьте таймауты в `makeRequest()`
- Добавьте больше retry попыток

### 3. **Ошибки CORS**
- Проверьте заголовки в `generate-enemies.php`
- Убедитесь, что запросы идут с правильного домена

## Дополнительные улучшения:

1. **Мониторинг API:**
   - Добавить метрики производительности
   - Отслеживать количество ошибок

2. **Кэширование:**
   - Добавить Redis/Memcached для продакшена
   - Автоматическая очистка устаревшего кэша

3. **Rate Limiting:**
   - Ограничение количества запросов к D&D API
   - Очередь запросов при превышении лимитов
